### CAP
#### 什么是 CAP？
假设某电商，在北京、杭州、上海三个城市建立了仓库，同时建立了对应的服务器{A, B, C}用于存储商品信息。比如，某电吹风在北京仓库有 
20 个，在杭州仓库有 10 个，在上海仓库有 30 个。那么，CAP 这三个字母在这个例子中分别代表什么呢?

`C 代表 Consistency，一致性`，是指所有节点在同一时刻的数据是相同的，即更新操作执行结束并响应用户完成后，所有节点存储的数据会保持相同。

>在电商系统中，A、B、C 中存储的该电吹风的数量应该是 20+10+30=60。假设，现在有一个北京用户买走一个电吹风，服务器 A 会更新数据为
 60-1=59，与此同时要求 B 和 C 也更新为 59，以保证在同一时刻，无论访问 A、B、C 中的哪个服务器，得到的数据均是 59。
 
`A 代表 Availability，可用性`，是指系统提供的服务一直处于可用状态，对于用户的请求可即时响应。
>在电商系统中，用户在任一时刻向 A、B、C 中的任一服务器发出请求时，均可得到即时响应，比如查询商品信息等。

`P 代表 Partition Tolerance，分区容错性`，是指在分布式系统遇到网络分区的情况下，仍然可以响应用户的请求。网络分区是指因为网络故障
导致网络不连通，不同节点分布在不同的子网络中，各个子网络内网络正常。
> 在电商系统中，假设 C 与 A 和 B 的网络都不通了，A 和 B 是相通的。也就是说，形成了两个分区{A, B}和{C}，在这种情况下，系统仍能
响应用户请求。

`CAP 理论指的就是，在分布式系统中 C、A、P 这三个特征不能同时满足，只能满足其中两个`
接下来，我就通过一个例子和你进一步解释下，什么是 CAP 以及 CAP 为什么不能同时满足吧。
网络中有两台服务器 Server1 和 Server2，分别部署了数据库 DB1 和 DB2，这两台机器组成一个服务集群，DB1 和 DB2 两个数据库中的数
据要保持一致，共同为用户提供服务。用户 User1 可以向 Server1 发起查询数据的请求，用户 User2 可以向服务器 Server2 发起查询数据
的请求，它们共同组成了一个分布式系统。

对这个系统来说，分别满足 C、A 和 P 指的是：
+ 在满足一致性 C 的情况下，Server1 和 Server2 中的数据库始终保持一致，即 DB1 和 DB2 内容要始终保持相同；  
+ 在满足可用性 A 的情况下，用户无论访问 Server1 还是 Server2，都会得到即时响应；
+ 在满足分区容错性 P 的情况下，Server1 和 Server2 之间即使出现网络故障也不会影响 Server1 和 Server2 分别处理用户的请求。

当用户发起请求时，收到请求的服务器会及时响应，并将用户更新的数据同步到另一台服务器，保证数据一致性。具体的工作流程
1 用户 User1 向服务器 Server1 发起请求，将数据库 DB1 中的数据 a 由 1 改为 2；  
2 系统会进行数据同步，即图中的 S 操作，将 Server1 中 DB1 的修改同步到服务器 Server2 中，使得 DB2 中的数据 a 也被修改为 2；  
3 当 User2 向 Server2 发起读取数据 a 的请求时，会得到 a 最新的数据值 2。  

`这其实是在网络环境稳定、系统无故障的情况下的工作流程。但在实际场景中，网络环境不可能百分之百不出故障，比如网络拥塞、网卡故障等`，
会导致网络故障或不通，从而导致节点之间无法通信，或者集群中节点被划分为多个分区，分区中的节点之间可通信，分区间不可通信。

`1`这种由网络故障导致的集群分区情况，通常被称为“网络分区”。`
在分布式系统中，网络分区不可避免，因此分区容错性 P 必须满足, 接下来，我们就来讨论一下`在满足分区容错性 P 的情况下，一致性 C 和可用性 A 是否可以同时满足`。

假设，Server1 和 Server2 之间网络出现故障，User1 向 Server1 发送请求，将数据库 DB1 中的数据 a 由 1 修改为 2，而
 Server2 由于与 Server1 无法连接导致数据无法同步，所以 DB2 中 a 依旧是 1。这时，`User2 向 Server2 发送读取数据 a 的请求时
 ，Server2 无法给用户返回最新数据，那么该如何处理呢`？
 
 我们能想到的处理方式有如下两种。
`第一种处理方式是`，保证一致性 C，牺牲可用性 A：Server2 选择让 User2 的请求阻塞，一直等到网络恢复正常，Server1 被修改的数据同步更
新到 Server2 之后，即 DB2 中数据 a 修改成最新值 2 后，再给用户 User2 响应。 
`第二种处理方式是`，保证可用性 A，牺牲一致性 C：Server2 选择将旧的数据 a=1 返回给用户，等到网络恢复，再进行数据同步。

> 除了以上这两种方案，没有其他方案可以选择。可以看出：在满足分区容错性 P 的前提下，一致性 C 和可用性 A 只能选择一个，无法同时满足。

##### CAP 选择策略及应用
C、A 和 P，没有谁优谁劣，只是不同的分布式场景适合不同的策略
. 对于涉及钱的交易时，数据的一致性至关重要，因此保 CP 弃 A 应该是最佳选择  
. 对于其他场景，大多数情况下的做法是选择 AP 而牺牲 C，因为很多情况下不需要太强的一致性（数据始终保持一致），只要满足最终一致性即可  
. 在分布式系统中，现在的网络基础设施无法做到始终保持稳定，网络分区（网络不连通）难以避免。牺牲分区容错性 P，就相当于放弃使用分布式系统。

### 分布式数据存储系统
#### 什么是分布式数据存储系统
顾客到商店购物时，导购会根据顾客想要购买的商品引导顾客到相应的货架，然后顾客从这个货架上获取要购买的商品，完成购物。这里的顾客
就是图中的应用程序，导购就相当于分布式操作引擎，它会按照一定的规则找到相应的货架，货架就是存储数据的不同机器节点。其实，这个过
程就是分布式存储系统中获取数据的通用流程，`顾客、导购和货架`组成了分布式存储系统的三要素，分别对应着分布式领域中的
`数据生产者 / 消费者、数据索引和数据存储`。

顾客：生产和消费数据
导购：确定数据位置
货架：存储数据

根据数据的特征，这些不同的数据通常被划分为三类：结构化数据、半结构化数据和非结构化数据。
+ 结构化数据通常是指关系模型数据，其特征是数据关联较大、格式固定, 因此一般采用分布式关系数据库进行存储和查询
+ 半结构化数据通常是指非关系模型的，有基本固定结构模式的数据,其特征是数据之间关系比较简单,一般采用分布式键值系统(k,v)进行存储和使用 
+ 非结构化数据是指没有固定模式的数据，其特征是数据之间关联不大,比如文本数据就是一种非结构化数据。这种数据可以存储到文档中，通过 ElasticSearch（一个分布式全文搜索引擎）等进行检索。
>针对这三种不同的数据类型，存储“货架”可以大致划分为以下三种：
> + 分布式数据库，通过表格来存储结构化数据，方便查找。常用的分布式数据库有 MySQL Sharding、Microsoft SQL Azure、Google Spanner、Alibaba OceanBase 等。
> + 分布式键值系统，通过键值对来存储半结构化数据。常用的分布式键值系统有 Redis、Memcache..
> + 分布式存储系统，通过文件、块、对象等来存储非结构化数据。常见的分布式存储系统有 Ceph、GFS、HDFS、Swift

在实际的分布式存储系统中，数据分片和数据复制通常是共存的：
+ 数据通过分片方式存储到不同的节点上，以减少单节点的性能瓶颈问题；
+ 而数据的存储通常用主备方式保证可靠性，也就是对每个节点上存储的分片数据，采用主备方式存储，以保证数据的可靠性。其中，主备节点上数据的一致，是通过数据复制技术实现的。

`对货架材料也就是存储介质的选择，本质就是选择将数据存储在磁盘还是内存（缓存）上`：
+ 磁盘存储量大，但 IO 开销大，访问速度较低，常用于存储不经常使用的数据。比如，电商系统中，排名比较靠后或购买量比较少、甚至无人购买的商品信息，通常就存储在磁盘上。
+ 内存容量小，访问速度快，因此常用于存储需要经常访问的数据。比如，电商系统中，购买量比较多或排名比较靠前的商品信息，通常就存储在内存中。


### 数据分布方法
#### 哈希
哈希是一种非常常用的数据分布方法，其核心思想是，首先确定一个哈希函数，然后通过计算得到对应的存储节点

假设，有三个存储节点，分别为 Node1、Node2 和 Node3；现有以下数据，ID 
的范围为[0,1000]：
```
D0:{ id:100, name:‘a0’}、
D1:{ id:200, name:‘a1’}、
D2:{ id:300, name:‘a2’}、
D3:{ id:400, name:‘a3’}、
D4:{ id:500, name:‘a4’}、
D5:{ id:600, name:‘a5’}、
D6:{ id:700, name:‘a6’}。
```
>假设，哈希函数为“id% 节点个数”，通过计算可以得到每个数据应该存入的节点。在这个例子中，哈希函数是“id%3”，结果为 0 的数
>据存入 Node1、结果为 1 的数据存入 Node2、结果为 2 的数据存入 Node3。

哈希算法的一个优点是，只要哈希函数设置得当，可以很好地保证数据均匀性，`但有一个较为严重的缺点，就是稳定性较差`。  
随着数据量的增加，三个节点的容量无法再满足存储需求了，需要再添加一个节点。这时，哈希函数变成了 id%4，原先存储在那三个节点的数据
需要重新计算，然后存入相应节点，即需要大规模的数据迁移，显然会降低稳定性  
`所以，哈希方法适用于同类型节点且节点数量比较固定的场景`  

#### 一致性哈希








 


 

