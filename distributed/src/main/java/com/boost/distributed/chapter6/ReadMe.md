### CAP
#### 什么是 CAP？
假设某电商，在北京、杭州、上海三个城市建立了仓库，同时建立了对应的服务器{A, B, C}用于存储商品信息。比如，某电吹风在北京仓库有 
20 个，在杭州仓库有 10 个，在上海仓库有 30 个。那么，CAP 这三个字母在这个例子中分别代表什么呢?

`C 代表 Consistency，一致性`，是指所有节点在同一时刻的数据是相同的，即更新操作执行结束并响应用户完成后，所有节点存储的数据会保持相同。

>在电商系统中，A、B、C 中存储的该电吹风的数量应该是 20+10+30=60。假设，现在有一个北京用户买走一个电吹风，服务器 A 会更新数据为
 60-1=59，与此同时要求 B 和 C 也更新为 59，以保证在同一时刻，无论访问 A、B、C 中的哪个服务器，得到的数据均是 59。
 
`A 代表 Availability，可用性`，是指系统提供的服务一直处于可用状态，对于用户的请求可即时响应。
>在电商系统中，用户在任一时刻向 A、B、C 中的任一服务器发出请求时，均可得到即时响应，比如查询商品信息等。

`P 代表 Partition Tolerance，分区容错性`，是指在分布式系统遇到网络分区的情况下，仍然可以响应用户的请求。网络分区是指因为网络故障
导致网络不连通，不同节点分布在不同的子网络中，各个子网络内网络正常。
> 在电商系统中，假设 C 与 A 和 B 的网络都不通了，A 和 B 是相通的。也就是说，形成了两个分区{A, B}和{C}，在这种情况下，系统仍能
响应用户请求。

`CAP 理论指的就是，在分布式系统中 C、A、P 这三个特征不能同时满足，只能满足其中两个`
接下来，我就通过一个例子和你进一步解释下，什么是 CAP 以及 CAP 为什么不能同时满足吧。
网络中有两台服务器 Server1 和 Server2，分别部署了数据库 DB1 和 DB2，这两台机器组成一个服务集群，DB1 和 DB2 两个数据库中的数
据要保持一致，共同为用户提供服务。用户 User1 可以向 Server1 发起查询数据的请求，用户 User2 可以向服务器 Server2 发起查询数据
的请求，它们共同组成了一个分布式系统。

对这个系统来说，分别满足 C、A 和 P 指的是：
+ 在满足一致性 C 的情况下，Server1 和 Server2 中的数据库始终保持一致，即 DB1 和 DB2 内容要始终保持相同；  
+ 在满足可用性 A 的情况下，用户无论访问 Server1 还是 Server2，都会得到即时响应；
+ 在满足分区容错性 P 的情况下，Server1 和 Server2 之间即使出现网络故障也不会影响 Server1 和 Server2 分别处理用户的请求。

当用户发起请求时，收到请求的服务器会及时响应，并将用户更新的数据同步到另一台服务器，保证数据一致性。具体的工作流程
1 用户 User1 向服务器 Server1 发起请求，将数据库 DB1 中的数据 a 由 1 改为 2；  
2 系统会进行数据同步，即图中的 S 操作，将 Server1 中 DB1 的修改同步到服务器 Server2 中，使得 DB2 中的数据 a 也被修改为 2；  
3 当 User2 向 Server2 发起读取数据 a 的请求时，会得到 a 最新的数据值 2。  

`这其实是在网络环境稳定、系统无故障的情况下的工作流程。但在实际场景中，网络环境不可能百分之百不出故障，比如网络拥塞、网卡故障等`，
会导致网络故障或不通，从而导致节点之间无法通信，或者集群中节点被划分为多个分区，分区中的节点之间可通信，分区间不可通信。

`1`这种由网络故障导致的集群分区情况，通常被称为“网络分区”。`
在分布式系统中，网络分区不可避免，因此分区容错性 P 必须满足, 接下来，我们就来讨论一下`在满足分区容错性 P 的情况下，一致性 C 和可用性 A 是否可以同时满足`。

假设，Server1 和 Server2 之间网络出现故障，User1 向 Server1 发送请求，将数据库 DB1 中的数据 a 由 1 修改为 2，而
 Server2 由于与 Server1 无法连接导致数据无法同步，所以 DB2 中 a 依旧是 1。这时，`User2 向 Server2 发送读取数据 a 的请求时
 ，Server2 无法给用户返回最新数据，那么该如何处理呢`？
 
 我们能想到的处理方式有如下两种。
`第一种处理方式是`，保证一致性 C，牺牲可用性 A：Server2 选择让 User2 的请求阻塞，一直等到网络恢复正常，Server1 被修改的数据同步更
新到 Server2 之后，即 DB2 中数据 a 修改成最新值 2 后，再给用户 User2 响应。 
`第二种处理方式是`，保证可用性 A，牺牲一致性 C：Server2 选择将旧的数据 a=1 返回给用户，等到网络恢复，再进行数据同步。

> 除了以上这两种方案，没有其他方案可以选择。可以看出：在满足分区容错性 P 的前提下，一致性 C 和可用性 A 只能选择一个，无法同时满足。

##### CAP 选择策略及应用
C、A 和 P，没有谁优谁劣，只是不同的分布式场景适合不同的策略
. 对于涉及钱的交易时，数据的一致性至关重要，因此保 CP 弃 A 应该是最佳选择  
. 对于其他场景，大多数情况下的做法是选择 AP 而牺牲 C，因为很多情况下不需要太强的一致性（数据始终保持一致），只要满足最终一致性即可  
. 在分布式系统中，现在的网络基础设施无法做到始终保持稳定，网络分区（网络不连通）难以避免。牺牲分区容错性 P，就相当于放弃使用分布式系统。

### 分布式数据存储系统
#### 什么是分布式数据存储系统
顾客到商店购物时，导购会根据顾客想要购买的商品引导顾客到相应的货架，然后顾客从这个货架上获取要购买的商品，完成购物。这里的顾客
就是图中的应用程序，导购就相当于分布式操作引擎，它会按照一定的规则找到相应的货架，货架就是存储数据的不同机器节点。其实，这个过
程就是分布式存储系统中获取数据的通用流程，`顾客、导购和货架`组成了分布式存储系统的三要素，分别对应着分布式领域中的
`数据生产者 / 消费者、数据索引和数据存储`。

顾客：生产和消费数据
导购：确定数据位置
货架：存储数据

根据数据的特征，这些不同的数据通常被划分为三类：结构化数据、半结构化数据和非结构化数据。
+ 结构化数据通常是指关系模型数据，其特征是数据关联较大、格式固定, 因此一般采用分布式关系数据库进行存储和查询
+ 半结构化数据通常是指非关系模型的，有基本固定结构模式的数据,其特征是数据之间关系比较简单,一般采用分布式键值系统(k,v)进行存储和使用 
+ 非结构化数据是指没有固定模式的数据，其特征是数据之间关联不大,比如文本数据就是一种非结构化数据。这种数据可以存储到文档中，通过 ElasticSearch（一个分布式全文搜索引擎）等进行检索。
>针对这三种不同的数据类型，存储“货架”可以大致划分为以下三种：
> + 分布式数据库，通过表格来存储结构化数据，方便查找。常用的分布式数据库有 MySQL Sharding、Microsoft SQL Azure、Google Spanner、Alibaba OceanBase 等。
> + 分布式键值系统，通过键值对来存储半结构化数据。常用的分布式键值系统有 Redis、Memcache..
> + 分布式存储系统，通过文件、块、对象等来存储非结构化数据。常见的分布式存储系统有 Ceph、GFS、HDFS、Swift

在实际的分布式存储系统中，数据分片和数据复制通常是共存的：
+ 数据通过分片方式存储到不同的节点上，以减少单节点的性能瓶颈问题；
+ 而数据的存储通常用主备方式保证可靠性，也就是对每个节点上存储的分片数据，采用主备方式存储，以保证数据的可靠性。其中，主备节点上数据的一致，是通过数据复制技术实现的。

`对货架材料也就是存储介质的选择，本质就是选择将数据存储在磁盘还是内存（缓存）上`：
+ 磁盘存储量大，但 IO 开销大，访问速度较低，常用于存储不经常使用的数据。比如，电商系统中，排名比较靠后或购买量比较少、甚至无人购买的商品信息，通常就存储在磁盘上。
+ 内存容量小，访问速度快，因此常用于存储需要经常访问的数据。比如，电商系统中，购买量比较多或排名比较靠前的商品信息，通常就存储在内存中。


### 数据分布方法
#### 哈希
哈希是一种非常常用的数据分布方法，其核心思想是，首先确定一个哈希函数，然后通过计算得到对应的存储节点

假设，有三个存储节点，分别为 Node1、Node2 和 Node3；现有以下数据，ID 
的范围为[0,1000]：
```
D0:{ id:100, name:‘a0’}、
D1:{ id:200, name:‘a1’}、
D2:{ id:300, name:‘a2’}、
D3:{ id:400, name:‘a3’}、
D4:{ id:500, name:‘a4’}、
D5:{ id:600, name:‘a5’}、
D6:{ id:700, name:‘a6’}。
```
>假设，哈希函数为“id% 节点个数”，通过计算可以得到每个数据应该存入的节点。在这个例子中，哈希函数是“id%3”，结果为 0 的数
>据存入 Node1、结果为 1 的数据存入 Node2、结果为 2 的数据存入 Node3。

哈希算法的一个优点是，只要哈希函数设置得当，可以很好地保证数据均匀性，`但有一个较为严重的缺点，就是稳定性较差`。  
随着数据量的增加，三个节点的容量无法再满足存储需求了，需要再添加一个节点。这时，哈希函数变成了 id%4，原先存储在那三个节点的数据
需要重新计算，然后存入相应节点，即需要大规模的数据迁移，显然会降低稳定性  
`所以，哈希方法适用于同类型节点且节点数量比较固定的场景`  

#### 一致性哈希
一致性哈希是指将存储节点和数据都映射到一个首尾相连的哈希环上，存储节点可以根据 IP 地址进行哈希，数据通常通过顺时针方向寻找的方
式，来确定自己所属的存储节点，即从数据映射在环上的位置开始，顺时针方向找到的第一个存储节点。

>假设数据 D0～D7 按照 ID 进行等值映射，即映射值与 ID 值相等，比如数据 D0 映射到哈希环上的值为 100，数据 D1 映射到哈希环上的
值为 200······；同时，假设存储节点 Node1、Node2 和 Node3 映射到哈希环上的值分别为 400、600、900。

>按照规则，D0，D1，D2 和 D3 顺时针方向的下一个存储节点为 Node1，因此 Node1 将存储数据 D0（id = 100）、D1（id = 200）、
>D2（id = 300）和 D3（id = 400）；同理，Node2 将存取数据 D4（id = 500）和 D5（id = 600），Node3 将存取数据 D6（id = 700）

`可以看出，一致性哈希是对哈希方法的改进，在数据存储时采用哈希方式确定存储位置的基础上，又增加了一层哈希，也就是在数据存储前，对存储节点预先进行了哈希`。

这种改进可以很好地解决哈希方法存在的稳定性问题。当节点加入或退出时，仅影响该节点在哈希环上顺时针相邻的后继节点。比如，当 Node2
 发生故障需要移除时，由于 Node3 是 Node2 顺时针方向的后继节点，本应存储到 Node2 的数据就会存储到 Node3 中，其他节点不会受到
 影响，因此不会发生大规模的数据迁移。
 
一致性哈希方法比较适合同类型节点、节点规模会发生变化的场景。
> 一致性哈希方法虽然提升了稳定性，`但随之而来的均匀性问题也比较明显，即对后继节点的负载会变大`。有节点退出后，该节点的后继节
点需要承担该节点的所有负载，如果后继节点承受不住，便会出现节点故障，导致后继节点的后继节点也面临同样的问题。

#### 带有限负载的一致性哈希
带有限负载的一致性哈希方法的核心原理是，给每个存储节点设置了一个存储上限值来控制存储节点添加或移除造成的数据不均匀。当数据按
照一致性哈希算法找到相应的存储节点时，要先判断该存储节点是否达到了存储上限；如果已经达到了上限，则需要继续寻找该存储节点顺时针
方向之后的节点进行存储。

哈希、一致性哈希、带有限负载的一致性哈希，都没有考虑节点异构性的问题。如果存储节点的性能好坏不一，数据分布方案还按照这些方法的
话，其实还是没做到数据的均匀分布。

#### 带虚拟节点的一致性哈希
带虚拟节点的一致性哈希方法，核心思想是根据每个节点的性能，为每个节点划分不同数量的虚拟节点，并将这些虚拟节点映射到哈希
环中，然后再按照一致性哈希算法进行数据映射和存储。

>假设，Node1 性能最差，Node2 性能一般，Node3 性能最好。以 Node1 的性能作为参考基准，Node2 是 Node1 的 2 倍，Node3 是 Node1 的 3 倍。

>因此，Node1 对应一个虚拟节点 Node1_1，Node2 对应 2 个虚拟节点 Node2_1 和 Node2_2，Node3 对应 3 个虚拟节点 Node3_1、Node3_2 和 Node3_3。
`目前 Memcached 缓存系统实现了该方法`

### 什么是数据复制技术？
概括来讲，数据复制是一种实现数据备份的技术。比如，现在有节点 1 和节点 2，节点 1 上存储了 10M 用户数据，直观地说，数据复制技
术就是将节点 1 上的这 10M 数据拷贝到节点 2 上，以使得节点 1 和节点 2 上存储了相同的数据，也就是节点 2 对节点 1 的数据进行
了备份。当节点 1 出现故障后，可以通过获取节点 2 上的数据，实现分布式存储系统的自动容错。

也就是说，数据复制技术，可以保证存储在不同节点上的同一份数据是一致的。这样当一个节点故障后，可以从其他存储该数据的节点获取数
据，避免数据丢失，进而提高了系统的可靠性。

在这个过程中，又是如何实现备数据库替代主数据库的呢？这，就涉及到数据一致性的问题了，即只有主备数据库中的数据保持一致时，才可实现
主备的替换。因此，`在这个例子中，数据复制技术实际就是指，如何让主备数据库保持数据一致的技术`。

+ 基于CAP理论， 在分布式存储系统中，分区容错性是肯定要满足的，为此需要在一致性和可用性之间做出权衡。

就导致出现了多种数据复制技术方法，大体上有三类：
+ 第一类方法，比较注重一致性，比如同步复制技术；
+ 第二类方法，则更注重可用性，比如异步复制技术；
+ 第三类方法，是介于前两者之间的，比如半同步复制技术。

#### 同步复制技术原理及应用
同步复制技术是指，当用户请求更新数据时，主数据库必须要同步到备数据库之后才可给用户返回，即如果主数据库没有同步到备数据库，用
户的更新操作会一直阻塞。这种方式`保证了数据的强一致性，但牺牲了系统的可用性`。
> `同步复制技术经常用于分布式数据库主备场景（对于一主多备场景，由于多个备节点均要更新成功后，主节点才响应用于，
>所需时延比较长）或对数据一致性有严格要求的场合，比如金融、交易之类的场景`。

#### 异步复制技术原理及应用
异步复制技术是指，当用户请求更新数据时，主数据库处理完请求后可直接给用户响应，而不必等待备数据库完成同步，即备数据库会异步进
行数据的同步，用户的更新操作不会因为备数据库未完成数据同步而导致阻塞。显然，`这种方式保证了系统的可用性，但牺牲了数据的一致性`。
>除了 MySQL 集群，在缓存数据库 Redis 集群中，采用的也是异步复制技术，因此性能较高。但，在 Redis 中还会有其他机制来保证数据的一致性

#### 半同步复制技术原理及应用
半同步复制技术的核心是，用户发出写请求后，主数据库会执行写操作，并给备数据库发送同步请求，但`主数据库不用等待所有备数据库回
复数据同步成功便可响应用户，也就是说主数据库可以等待一部分备数据库同步完成后响应用户写操作执行成功`。

##### 半同步复制技术通常有两种方式：
+ 一种是，当主数据库收到多个备数据库中的某一个回复数据同步成功后，便可给用户响应写操作完成；
+ 另一种是，主数据库等超过一半节点（包括主数据库）回复数据更新成功后，再给用户响应写操作成功。

### 什么是分布式缓存?
分布式缓存就是指在分布式环境或系统下，把一些热门数据存储到离用户近、离应用近的位置，并尽量存储到更快的设备，以减少远程数据传输
的延迟，让用户和应用可以很快访问到想要的数据

`我们通常说的分布式数据缓存，属于计算机应用中的缓存的一种`。而计算机应用中的缓存，一般指内存，即内存存储了用户经常访问的数据，
用户或应用不再需要到磁盘中去获取相应的数据，大幅提高访问速度。

#### 分布式缓存原理
以主流的分布式缓存系统 Redis 和 Memcached 为例
##### Redis 分布缓存原理
`Redis 的全称是 Remote Dictionary Server`（远程字典服务器）。可以直观地看出，它是以字典结构将数据存储在内存中，应用可直
接到内存读写 Redis 存储的数据。  

Redis 集群是一个典型的去中心化结构，每个节点都负责一部分数据的存储，同时，每个节点还会进行主备设计来提高 Redis 的可靠性  
Redis 中与缓存关系最紧密的三个特性：`支持多数据结构、支持持久化和主备同步`。

+ 第一，Redis 支持多数据结构
Redis 是一个基于内存的 key-value 数据库, 为了方便支持多应用的缓存, 支持的数据结构不仅有简单的 k／v 类型，还可以
支持 List、Set、Hash 等复杂类型的存储。
+ 第二，Redis 支持持久化。
1 RDB（Redis DataBase）
> 也称快照方式，简单来说就是 Redis 会定时将内存中的数据备份到磁盘中，形成一个快照，比如每天保存一下过去一周的数据。这样当节点
>出现故障时，可以根据快照恢复到不同版本的数据。这种方式有一个明显的缺点，是会造成数据丢失，即当节点出现故障时，新数据可能还未备
>份到磁盘中。

2 AOF（Append Only File）
> 的出现主要弥补了 RDB 数据不一致的问题，其思想与上一讲提到的数据库复制技术中 binary log 类似，即记录下 Redis 中所有的更新操作。
> + AOF_FSYNC_NO （不同步），即不会自动触发写操作的同步；
> + AOF_FSYNC_EVERYSEC （每秒同步），即每隔一秒都会将写操作同步到磁盘；
> + AOF_FSYNC_ALWAYS （每次写都同步），即每次发生写操作会立即同步到磁盘。

Redis 中`默认采用 AOF_FSYNC_EVERYSEC（每秒同步）的策略，因为这种策略的性能很不错，而且一旦出现故障，最多只会丢失一秒的数据`。

+ Redis 支持主备同步
在 Redis 中，采用的是异步复制技术，但 Redis 可以通过配置 min-replicas-to-write 和 min-replicas-max-lag 这两个参数来有效地保证数据一致性。

比如，设置 min-replicas-to-write=3、min-replicas-max-lag=10，表示当至少有 3 个备数据库连接主数据库的延迟时间小于 10s 时，
主数据库才可以执行写操作。延迟时间是从最后一次收到备数据库的心跳开始计算，通常每秒发送一次心跳。

除了上面对写操作的同步，在 Redis 中，还有两种情况是需要进行数据同步的：
> + 一种情况是初次同步，即备数据库刚启动时的数据同步；
> + 另一种情况是，因网络故障导致主备数据库断开连接，待网络恢复后的备数据库的数据同步。

针对这两种情况，Redis 提供了两种同步模式，即`完整重同步和部分重同步`。

`完整重同步`的流程如下所示：
1 当备服务器启动时，会向主服务器发送 SYNC 命令；  
2 主服务器收到命令后会生成 RDB（快照）文件，并记录从现在起新执行的写操作；  
3 RDB 生成后会发送给备服务器，备服务器通过 RDB 文件进行数据更新；  
4 更新完成后，主服务器再将新记录的写操作发送给备服务器，备服务器执行完这些新记录的写操作，便与主服务器的数据保持一致了。  

`部分重同步`就是，当网络恢复后，主数据库将主备数据库断开连接之后的一系列写操作发送给备服务器，备数据库执行这些写操作，
从而保证数据保持一致。


##### Memcached 分布式缓存原理
Redis 的集群结构是每个节点负责一部分哈希槽，且每个节点可以设计主备。与 Redis 不同，Memcached 集群采用一致性哈希的思路，
使用的是 Ketama 算法。该算法的主要思想就是，`带虚拟节点的一致性哈希算法`。

采用带虚拟节点的一致性哈希方法，有一个优点是，当添加或移除节点时，不会出现大规模的数据迁移

对于数据结构的支持，Memcached 仅支持简单的 k／v 数据类型，如果想要存储复杂的数据类型，比如 List、Set 和 Hash 等，需要客户
端自己处理，将其转化为字符串然后进行存储。这样就导致了一个缺点，操作不灵活。比如，Memcached 存储的数组中有一个元素需要修改，则
需要将整个数组的数据取出来  

`而对于持久化，Memcached 是不支持的`。这意味着断电时，Memcached 中存储的数据将会全部丢失。因为内存是一种易失性存储设备，断电后将不会存储数据。

在 Memcached 中，服务器和服务器之间没有任何通信，即自身不支持主备。如果想要实现高可用，需要通过第三方实现。比如，Repcached 
实现了 Memcached 的复制功能，支持一主一备，从而使 Memcached 满足高可用。













 


 

