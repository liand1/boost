##本章内容
### 1.1 从单兵到游击队,集团军
单机模式的主要问题是：性能受限、存在单点失效问题。
游击队模式：数据并行或数据分布式

##### 单兵模式：单机模式
所谓单机模式是指，所有应用程序和数据均部署在一台电脑或服务器上，由一台计算机完成所有的处理。

这种模式的好处是功能、代码和数据集中，便于维护、管理和执行，但计算效率是瓶颈。也就是说单机模式性能受限，也存在单点失效的问题。

##### 游击队模式：数据并行或数据分布式
这种模式的好处是，可以利用多台计算机并行处理多个请求，使得我们可以在相同的时间内完成更多的请求处理，解决了单机模式的计算效率瓶颈问题。
但这种模式仍然存在如下几个问题，在实际应用中，我们需要对其进行相应的优化：  
+ 相同的应用部署到不同的服务器上，当大量用户请求过来时，如何能比较均衡地转发到不同的应用服务器上呢？解决这个问题的方法是设计一个
负载均衡器，我会在“分布式高可靠”模块与你讲述负载均衡的相关原理。
+ 当请求量较大时，对数据库的频繁读写操作，使得数据库的 IO 访问成为
瓶颈。解决这个问题的方式是读写分离，读数据库只接收读请求，写数据库只接收写请求，当然读写数据库之间要进行数据同步，以保证数据
一致性。    
+ 当有些数据成为热点数据时，会导致数据库访问频繁，压力增大。解决这个问题的方法是引入缓存机制，将热点数据加载到缓存中，一
方面可以减轻数据库的压力，另一方面也可以提升查询效率  

> `数据并行模式实现了多请求并行处理，但如果单个请求特别复杂，比方说需要几天甚至一周时间的时候，数据并行模式的整体计算效率还是不够高`

##### 集团军模式：任务并行或任务分布式
任务并行指的是，将单个复杂的任务拆分为多个子任务，从而使得多个子任务可以在不同的计算机上并行执行。
>以铁路售票系统为例，任务并行首先是对应用进行拆分，比如按照领域模型将用户管理、火车票管理、订单管理拆分成多个子系统分别运行在不同
>的计算机或服务器上。换句话说，原本包括用户管理、火车票管理和订单管理的一个复杂任务，被拆分成了多个子任务在不同计算机或服务器上执行

可以看出，任务并行模式完成一项复杂任务主要有两个核心步骤：首先将单任务拆分成多个子任务，然后让多个子任务并行执行。这种模式和集团军
模式很像，任务拆分者对应领导者，不同子系统对应不同兵种，不同子程序执行不同任务就像不同的兵种执行不同的命令一样，并且运行相同子系统
或子任务的计算机又可以组成一个兵团。

`集团军模式在提供了更好的性能、扩展性、可维护性的同时，也带来了设计上的复杂性问题`

一个简单的原则就是：任务执行时间短，数据规模大、类型相同且无依赖，则可采用数据并行；如果任务复杂、执行时间长，且任务可拆分为多个子
任务，则考虑任务并行。在实际业务中，通常是这两种模式并用。  

### 1.2 什么是分布式
`分布式其实就是将相同或相关的程序运行在多台计算机上，从而实现特定目标的一种计算方式。`
数据并行、任务并行其实都可以算作是分布式的一种形态。产生分布式的最主要驱动力量，是我们对于性能、可用性及可扩展性的不懈追求。

### 1.3 分布式系统的指标：啥是分布式的三围
从分布式技术的起源可以看出，分布式系统的出现就是为了用廉价的、普通的机器解决单个计算机处理复杂、大规模数据和任务时存在的性能
问题、资源瓶颈问题，以及可用性和可扩展性问题。换句话说，分布式的目的是用更多的机器，处理更多的数据和更复杂的任务。
由此可以看出，`性能、资源、可用性和可扩展性`是分布式系统的重要指标。没错，它们就是分布式系统的“三围”。

#### 1.3.1 性能（Performance）
不同的系统、服务要达成的目的不同，关注的性能自然也不尽相同，甚至是相互矛盾。常见的性能指标，包括吞吐量（Throughput）、
响应时间（Response Time）和完成时间（Turnaround Time）  

+ 吞吐量: 系统在一定时间内可以处理的任务数
常见的吞吐量指标有 QPS（Queries Per Second）、TPS（Transactions Per Second）和 BPS（Bits Per Second)
> + QPS: 即查询数每秒，用于衡量一个系统每秒处理的查询数。这个指标通常用于读操作，越高说明对读操作的支持越好,如果应用主要是读操作，那么需要重点考虑如何提高 QPS    
> + TPS: 即事务数每秒，用于衡量一个系统每秒处理的事务数。这个指标通常对应于写操作，越高说明对写操作的支持越好, 如果应用主要是写操作，那么需要重点考虑如何提高 TPS    
> + BPS: 即比特数每秒，用于衡量一个系统每秒处理的数据量。对于一些网络系统、数据管理系统，我们不能简单地按照请求数或事务数来衡量其性能。因为请求与请求、事务与事务之间也存在着很大的差异，比方说，有的事务大需要写入更多的数据。那么在这种情况下，BPS 更能客观地反应系统的吞吐量。    

+ 响应时间: 系统响应一个请求或输入需要花费的时间。响应时间直接影响到用户体验，对于时延敏感的业务非常重要。比如用户搜索导航，特别
是用户边开车边搜索的时候，如果响应时间很长，就会直接导致用户走错路。  

+ 完成时间: 系统真正完成一个请求或处理需要花费的时间。任务并行（也叫作任务分布式）模式出现的其中一个目的，就是缩短整个任务的
完成时间。特别是需要计算海量数据或处理大规模任务时，用户对完成时间的感受非常明显。
#### 1.3.2 资源（Resource Usage）
资源占用指的是，一个系统提供正常能力需要占用的硬件资源，比如 CPU、内存、硬盘等。  
一个系统在没有任何负载时的资源占用，叫做`空载资源占用`，体现了这个系统自身的资源占用情况。比如，你在手机上安装一个 App，
安装的时候通常会提示你有多少 KB，这就是该 App 的空载硬盘资源占用。对于同样的功能，空载资源占用越少，说明系统设计越优秀，
越容易被用户接受。  
一个系统满额负载时的资源占用，叫做`满载资源占用`，体现了这个系统全力运行时占用资源的情况，也体现了系统的处理能力。同样的硬件配置上
，运行的业务越多，资源占用越少，说明这个系统设计得越好。
#### 1.3.3 可用性（Availability）
可用性，通常指的是系统在面对各种异常时可以正确提供服务的能力。可用性是分布式系统的一项重要指标，衡量了系统的鲁棒性，是系统容错
能力的体现。  
系统的可用性可以用`系统停止服务的时间与总的时间之比衡量`。假设一个网站总的运行时间是 24 小时，在 24 小时内，如果网站故障导致不可用
的时间是 4 个小时，那么系统的可用性就是 4/24=0.167，也就是 0.167 的比例不可用，或者说 0.833 的比例可用。  
除此之外，系统的可用性还可以用`某功能的失败次数与总的请求次数之比来衡量`，比如对网站请求 1000 次，其中有 10 次请求失败，
那么可用性就是 99%。

>你可能经常在一个系统的宣传语中见到或听到 3 个 9（或 3N，3 Nines）、5 个 9（或 9N，9 Nines）。这些宣传语中所说的 3 个 9、5 个 9，
实际上就是系统厂商对可用性的一种标榜，表明该系统可以在 99.9% 或 99.999% 的时间里能对外无故障地提供服务。

#### 1.3.4 可扩展性（Scalability）
可扩展性，指的是分布式系统通过扩展集群机器规模提高系统性能 (吞吐、响应时间、 完成时间)、存储容量、计算能力的特性，是分布式系统的特有性质。  

分布式系统的设计初衷，就是利用集群多机的能力处理单机无法解决的问题。然而，完成某一具体任务所需要的机器数目，即集群规模，
取决于单个机器的性能和任务的要求。  

`当任务的需求随着具体业务不断提高时，除了升级系统的性能做垂直 / 纵向扩展外，另一个做法就是通过增加机器的方式去水平 / 横向扩展系统规模。`

这里垂直 / 纵向扩展指的是，增加单机的硬件能力，比如 CPU 增强、内存增大等；水平 / 横向扩展指的就是，增加计算机数量。
好的分布式系统总在追求“线性扩展性”，也就是说系统的某一指标可以随着集群中的机器数量呈线性增长。  

+ 衡量系统可扩展性的常见指标是加速比（Speedup），也就是一个系统进行扩展后相对扩展前的性能提升。  

+ 如果你的扩展目标是为了提高系统吞吐量，则可以用扩展后和扩展前的系统吞吐量之比进行衡量。如果你的目标是为了缩短完成时间，
则可以用扩展前和扩展后的完成时间之比进行衡量。  

#### 1.4 不同场景下分布式系统的指标
我们都希望自己的分布式系统是高性能、高可用、高扩展和低资源占用的。但出于硬件成本、开发效率等因素的约束，我们无法在性能、可用性、
可靠性和资源占用做到面面俱到。因此，在不同的业务场景中，设计者们需要有所取舍。  

接下来，我带你一起看一下典型的电商、IoT、电信、HPC（高性能计算）、大数据、云计算、区块链等业务或系统对不同指标的诉求。  

+ 电商系统  
> 对于一个电商系统而言，系统设计者最看重的是吞吐量，为了处理更多的用户访问或订单业务，甚至不惜牺牲一些硬件成本。
+ IoT(Internet of Things物联网)
> 对于一个 IoT 系统而言，设计者最看重的是资源占用指标，因为在一些功能极简的 IoT 设备上 RAM、ROM 的可用资源通常都是 KB 级的。
+ 电信业务
> 对于电信业务而言，最重要的无疑是响应时间、完成时间，以及可用性。因为，你在打电话时不希望你的声音半天才被对方听到，也不希望半天才听到对方的回应，更不希望你的电话无法拨出。
+ HPC（高性能计算）
> HPC 系统最显著的特点是任务执行时间极长，一个天体物理任务的分析和计算通常耗时数周甚至数月。因此，通过水平扩展来提高系统的加速比，是 HPC 系统设计者需要关注的。
+ 大数据
> 大数据任务的处理时间可能相对 HPC 系统来讲比较短，但常见的完成时间也达到了小时级，所以扩展性也是大数据系统首先要考虑的。
+ 云计算
> 对于一个云计算系统而言，常见任务是虚拟主机或容器的创建、资源调整、销毁等操作，如何减少这些操作的完成时间，从而提升用户体验是设计者们要重点关注的。另外，云计算系统本质上卖的是资源，那么降低系统本身的资源开销，也是系统设计的重中之重。
+ 区块链
> 区块链的吞吐量比较低，比特币的 TPS 只有 7 次每秒，单平均一次交易的确认就需要 10 分钟左右，因此吞吐量和完成时间通常是区块链系统设计者的首要目标